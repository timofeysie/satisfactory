# June 2022

## TODO

- (done) add the aspect name at the end of the file before the file extension
- (done) return the name of the generated aspect image
- display the generated image
- allow the user to change the offset

## Work

Two weeks into June and still not able to display the generated image.  Sometimes the generated image also is not generated at all.

### add the aspect name at the end of the file before the file extension

Where is this done already?  There are a few places where the file extension is found.

It's a pretty small function in the trends.component:

```js
  removeFileExt(text: string) {
    const dot = text.lastIndexOf('.');
    const newText = text.substring(0, dot);
    return newText;
  }
```

Making that return the two parts, and now we have our correct file name:

Kylian_Mbapp%C3%A9_2018-portrait.jpg

### Display the generated image

First error:

core.js:6456 ERROR Error: NG0201: No provider for TemplateRef found. Find more at https://angular.io/errors/NG0201

That's what happens when you use ngIf without the asterix: *ngIf.

Next:

Kylian_Mbapp%C3%A9_2018.jpg:1          
GET http://localhost:4200/dist/apps/public/Kylian_Mbapp%C3%A9_2018.jpg 404 (Not Found)

The template is here:

libs\trends\src\lib\containers\image-preview\image-preview.component.html

To get here:

/dist/apps/public/

So try this:

<img src="{{ './../../../../../../' + portraitData.path + portraitData.fileName }}" />

Same result:

GET http://localhost:4200/dist/apps/public/Kylian_Mbapp%C3%A9_2018.jpg 404 (Not Found)

### Nx shared images

To get a place to store the poster images so that they can be read, we either use the assets in the trends project, or follow this:

This [issue on Nx shared images](https://github.com/nrwl/nx/issues/2230) says:

*The nx-examples repo has an example of storing shared assets in a lib. You can have app specific assets in the app assets folder such as maybe a specific logo or favicon just for that app. If assets are shared between different apps, you can create a lib with no typescript or anything and put them there. Unfortunately, you have to duplicate the assets config for each app which uses them but at least there is 1 copy.  Also note that nx won't find this dependency on it's own so we can add an implicitDependency to make Nx aware that those apps should be rebuilt when those assets change.*

The link for the nx-examples repo https://github.com/nrwl/nx-examples/blob/master/workspace.json#L49-L59

"shared-assets": "libs/shared/assets",

To generate a library:

nx g @nrwl/angular:lib shared-assets

*Libraries are shareable across libraries and applications. They can be imported from @nx-example/mylib.*

Now, how to add the implicitDependency?

*Some dependencies between projects and shared files cannot be inferred statically. You can configure those using implicitDependencies.*

project.json:

  "implicitDependencies": ["anotherlib"]

I think that generate scaffolding command will do more than we need.  The above says *create a lib with no typescript or anything*, which seems to rule out Angular.  So what is the generic lib command?

[This is an open issue](https://github.com/productboardlabs/multioss/issues/9) from the above closed issue which mentions: *We might load assets from cdn for better perf etc. For that purpose it would be great to have ability to create libs, that encapsulate those static assets, that can be easily shared/used within other libs/apps*

That's an interesting concept.  I thought one option would actually be just to upload all created images to S3 buckets, and replace edited version, but actually I don't know how to edit/delete images from the bucket yet.

I suppose though, if it's going to be used in an Angular app, along with a TypeScript NodeJS app, then the above scaffolding command will be OK.  Let's find out.

nx g @nrwl/angular:lib shared-assets

```shell
> demo-app@0.0.4 postinstall C:\Users\timof\repos\satisfactory
> ngcc --properties es2015 browser module main

npm WARN @cypress/webpack-preprocessor@4.1.5 requires a peer of webpack@^4.18.1 but none is installed. You must install peer dependencies yourself.
npm WARN @nestjs/mapped-types@1.0.0 requires a peer of class-transformer@^0.2.0 || ^0.3.0 || ^0.4.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nestjs/mapped-types@1.0.0 requires a peer of class-validator@^0.11.1 || ^0.12.0 || ^0.13.0 but none is installed. You must install peer dependencies yourself.
npm WARN @ngrx/entity@12.1.0 requires a peer of @ngrx/store@12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @ngrx/store-devtools@12.1.0 requires a peer of @ngrx/store@12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/common@12.1.0 requires a peer of @angular/common@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/common@12.1.0 requires a peer of @angular/core@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/express-engine@12.1.0 requires a peer of @angular/common@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/express-engine@12.1.0 requires a peer of @angular/core@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/express-engine@12.1.0 requires a peer of @angular/platform-server@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/module-map-ngfactory-loader@8.2.6 requires a peer of @angular/common@^8.2.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/module-map-ngfactory-loader@8.2.6 requires a peer of @angular/core@^8.2.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nguniversal/module-map-ngfactory-loader@8.2.6 requires a peer of @angular/platform-server@^8.2.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nrwl/next@13.9.6 requires a peer of next@^12.1.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nrwl/workspace@12.5.8 requires a peer of prettier@^2.3.0 but none is installed. You must install peer dependencies yourself.
npm WARN @nrwl/nx@7.8.7 requires a peer of jasmine-marbles@0.4.0 but none is installed. You must install peer dependencies yourself.
npm WARN acorn-import-assertions@1.8.0 requires a peer of acorn@^8 but none is installed. You must install peer dependencies yourself.
npm WARN ajv-keywords@3.5.2 requires a peer of ajv@^6.9.1 but none is installed. You must install peer dependencies yourself.
npm WARN eslint-config-next@12.1.4 requires a peer of eslint@^7.23.0 || ^8.0.0 but none is installed. You must install peer dependencies yourself.
CREATE libs/shared-assets/src/test-setup.ts
CREATE libs/shared-assets/tsconfig.spec.json
CREATE libs/shared-assets/.eslintrc.json
UPDATE package.json
UPDATE workspace.json
UPDATE nx.json
UPDATE tsconfig.base.json
UPDATE .vscode/extensions.json
UPDATE jest.config.js
```

Welcome to this projects 9th lib.

There is single file in the libs src directory:P

libs\shared-assets\src\lib\shared-assets.module.ts

Now how to add an assets directory.  I'm not sure actually if I did the right thing there.

 "shared-assets": "libs/shared/assets",

That's in the shared lib.  We called our's shared assets.  Well, it shows the shared directory is outside the src dir.

Next, add this to the trends lib project.json file.

"implicitDependencies": ["shared-assets"]

Actually, these are the details on the sample project from above:

apps/products/project.json

```json
  "tags": ["type:app", "scope:products"],
  "implicitDependencies": ["shared-assets", "shared-styles"]
```

We do have this:  nx.json

So should this happen?

```json
    "trends": {
      "tags": [],
      "implicitDependencies": ["shared-assets"]
    },
```

Not sure.  This is taking a long time I'm sure of.

*Angular developers can also configure projects in angular.json. Read this guide for more information.*

We don't have an angular.json file at all!  Sometimes I wonder why I set my self up for these complex problems.  I should have just been a UX designer...

Here we go.

*The project.json file contains configuration specific to its project. This file is often created when you use Nx Plugins. It configures custom executors, which are used instead of npm scripts. Custom executors are typed, toolable and provide a lot more flexibility for running long-live processes. They are also more composable.  If you're satisfied with npm scripts though, you will never see a project.json file in your workspace. But we encourage you to explore Nx Plugins and the power they bring.*

At the end of the demo project.json, we have the same as the above:

```json
  "tags": ["scope:myteam"],
  "implicitDependencies": ["anotherlib"]
```

So maybe what we have in the nx.json now will be fine.  

How do we test it out?  First, import it.

### Heroku login

I can't login as the MFA requires a code from my device, which was bricked and now have a new one.  How do I get a new QR code to setup the MFA on my new device?

*If you have lost access to your MFA device, follow our instructions to recover your account.*

*If you want to log in but don’t have your primary MFA verification method available, you can easily log in with a pre-generated recovery code.  Select Choose Another Option.*

But there is no "Choose Another Option" option.

I had sent an email to what I thought was the support email, but looking now, this was it: Heroku [undefined:noreply@heroku.com]

That's why that didn't work!

There is an [open question on SO](https://stackoverflow.com/questions/72021566/heroku-mfa-verification-using-a-recovery-code-does-work) about this.

I added a comment there: I'm having the same issue @heroku. If you select the forgotten password option, the next screen has an email to contact: account-lockout@heroku.com
curchod 4 mins ago

I will be able to answer that if I get a reply.  This might improve my lowly 255 reputation points.

### The original images are not making it into the test_img directory

Request URL: https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/ColoradoAvalancheWarmup.jpeg/240px-ColoradoAvalancheWarmup.jpeg
Request Method: GET
Status Code: 200

That network call looks OK.  But there is no output from the server.

Start in libs\trends\src\lib\containers\trends\trends.component.ts

Trying another image works:

['https://upload.wikimedia.org/wikipedia/commons/e/e2/Colorado_Avalanche_Playoffs%21.jpg']

But with the Colorado Avalanche image, not.  That's a good thing to know.  What's the filename for that one?

Also, this is poor error handling.  If the download fails for some reason, there should be a message to show on the front end.

https://upload.wikimedia.org/wikipedia/commons/thumb/b/b8/ColoradoAvalancheWarmup.jpeg/240px-ColoradoAvalancheWarmup.jpeg

trends.component.ts:465 download urls []


It is the ridiculous findExtension() function which wasn't looking for jpeg, only jpg.  I'm sure there are other ones also.  Really that whole rigamorole is terrible, and we should be getting the file extension for some meta data source.

Time to replace

dist/apps/public/

with

dist/apps/public/

ColoradoAvalancheWarmup.jpeg:1
GET http://localhost:4200/dist/apps/public/ColoradoAvalancheWarmup.jpeg 404 (Not Found)

On the server:

done creating ColoradoAvalancheWarmup-portrait.jpeg
err creating ColoradoAvalancheWarmup-portrait.jpeg [Error: extract_area: bad extract area

ColoradoAvalancheWarmup.jpeg:1
GET http://localhost:4200/dist/apps/public/ColoradoAvalancheWarmup.jpeg 404 (Not Found)

Yes, but:

libs\shared-assets\assets\Gabriel_Landeskog_-_Colorado_Avalanche_%28cropped1%29.jpg

imagePath 
dist/apps/public/ColoradoAvalancheWarmup.jpeg

libs\shared-assets\assets\ColoradoAvalancheWarmup.jpeg

Looks good to me.  Then wy the "bad extract area" error?

### bad extract area

What line is that error coming from?

### Input file is missing

(node:8080) UnhandledPromiseRejectionWarning: Error: Input file is missing:dist/apps/public/Gabriel_Landeskog_-_Colorado_Avalanche_(cropped1).jpg
(node:8080) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 10)

The actual file there in the shared assets lib is:

libs\shared-assets\assets\Gabriel_Landeskog_-_Colorado_Avalanche_%28cropped1%29.jpg

So it is an encoding issue here also.

We really need some logging to tell us where that is coming from without having to retrace the ui to service to controller to service.

(click)="onChooseSourceImage()" -> this.originalFileInput.nativeElement.click();

Then you have to look at the template native input element to see what it is attached to.

<input #originalFileInput
  (change)="sourceImageChosen($event)"

  sourceImageChosen(event) {
      const fileChosen = event.target.files[0]['name'];
      this.originalImageSelected.emit(fileChosen);

On the parent template:

  <demo-app-post-creation-form
    (originalImageSelected)="onOriginalImageSelected($event)"

That goes back down into this component where a behavior subject is waiting for a change:

            <demo-app-image-preview
              *ngIf="fullTopicForm.value.one?.imageChosen"
              [imageFileName]="fullTopicForm.value.one?.imageChosen"
            ></demo-app-image-preview>

this.trendsService.postImageMetadata(body).subscribe((result2) => {

This calls the POST: return this.httpClient.post('http://localhost:3333/api/image/', body, {

So look in the image POST API endpoint.

First of all, the logs are coming from async functions, so there could be a few lines from one fuction, and a few lines from another as they get their turn on the mystical Javascript event loop.

So having each line tell us where it's coming from is important.  But for now, we have console log.

```shell
ImageService.findOne: meta {
  format: 'jpeg',
  width: 2887,
  height: 1631,
  space: 'srgb',
  channels: 3,
  depth: 'uchar',
  density: 480,
  chromaSubsampling: '4:2:0',
  isProgressive: false,
  resolutionUnit: 'inch',
  hasProfile: false,
  hasAlpha: false,
  exif: <Buffer 45 78 69 66 00 00 4d 4d 00 2a 00 00 00 08 00 0b 01 0f 00 02 00 00 00 16 00 00 00 92 01 10 00 02 00 00 00 2d 00 00 00 a8 01 1a 00 05 00 00 00 01 00 00 ... 6570 more bytes>,
  xmp: <Buffer 3c 3f 78 70 61 63 6b 65 74 20 62 65 67 69 6e 3d 22 ef bb bf 22 20 69 64 3d 22 57 35 4d 30 4d 70 43 65 68 69 48 7a 72 65 53 7a 4e 54 63 7a 6b 63 39 64 ... 335 more bytes>
}
ImageService.create {
  path: 'dist/apps/public/',
  fileName: 'New_York_Rangers_December_11th_2010_Lundqvist.jpg',
  original: { width: 2887, height: 1631 },
  aspect: 'portrait',
  new: { left: 0, top: 0, width: 1133, height: 640 }
}
ImageService.create: imagePathdist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist.jpg
ImageService.create: meta {
  format: 'jpeg',
  width: 2887,
  height: 1631,
  space: 'srgb',
  channels: 3,
  depth: 'uchar',
  density: 480,
  chromaSubsampling: '4:2:0',
  isProgressive: false,
  resolutionUnit: 'inch',
  hasProfile: false,
  hasAlpha: false,
  exif: <Buffer 45 78 69 66 00 00 4d 4d 00 2a 00 00 00 08 00 0b 01 0f 00 02 00 00 00 16 00 00 00 92 01 10 00 02 00 00 00 2d 00 00 00 a8 01 1a 00 05 00 00 00 01 00 00 ... 6570 more bytes>,
  xmp: <Buffer 3c 3f 78 70 61 63 6b 65 74 20 62 65 67 69 6e 3d 22 ef bb bf 22 20 69 64 3d 22 57 35 4d 30 4d 70 43 65 68 69 48 7a 72 65 53 7a 4e 54 63 7a 6b 63 39 64 ... 335 more bytes>
}
ImageService.create: done creating New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg
```

Currently, after an image is downloaded and then images generated automatically, which is not going to work for stories.  I kind of feel like we need to have a new post type, so as well as 

Right now, it does work for other images.  But not for ColoradoAvalancheWarmup.jpeg.  Probably because of the extra long file extension is messing up our weak file type matching systems which is scattered all over the place because we assumed the code needed was too small to worry about making it reusable.

Anyhow, the image is not loaded into the front end after cropping:

```txt
post-creation-form.component.ts:150 fileChose New_York_Rangers_December_11th_2010_Lundqvist.jpg
image-preview.component.ts:32 post result New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg
dist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist.jpg:1          GET http://localhost:4200/dist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist.jpg net::ERR_CONNECTION_REFUSED
Image (async)
setProperty @ platform-browser.js:739
...
Show 109 more frames
post-creation-form.component.ts:153 sourceImageChosen: event.target.files array is empty
```

http://localhost:4200/
dist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist.jpg

Anyhow, the image is now being loaded:

http://localhost:4200/dist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg

dist/apps/public/New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg

libs\shared-assets\assets\New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg

There is no encoding issues.  That is the file.  So lets look at the shared-assets and trends lib config again.

Trends has this in the nx.json:

    "trends": {
      "tags": [],
      "implicitDependencies": ["shared-assets"]
    },

Maybe we also need to import it in the modules?

import { SharedAssetsModule } from '@demo-app/shared-assets';

Put that in the imports array, but still, the image is not found.  So back to googling after a short break.

### Share assets in the core nx tut

In the [nx core-tutorial](https://nx.dev/core-tutorial/03-share-assets) on step three it shows creating this file:

#### packages/ascii/project.json

```json
{
  "root": "packages/ascii",
  "sourceRoot": "packages/ascii/assets",
  "projectType": "library"
}
```

There is no packages directory for us.  How is that going to work here then?

The project is a bit off center.  Step 2 says "create a CLI written in Go".

That may be part of the more recent nx projects.  Here is the workspace directory structure begin in step 1:

```txt
myorg/
├── packages/
├── tools/
├── nx.json
├── package.json
├── README.md
└── tsconfig.base.json
```

Let's try it out.

## The packages directory

In the packages directory, there is a single empty file:

packages\.gitkeep

Whatever that is used for comes up in the next step installing something called Eleventy.

## Eleventy

Tried the same commands in a new nx workspace core project.

npm add -D @11ty/eleventy@1.0.0

What is Eleventy?

*A simpler static site generator. An alternative to Jekyll. Written in JavaScript. Transforms a directory of templates (of varying types) into HTML.*

Step 2. Then we create this file in the packages directory:

*Create a file at packages/blog/package.json with these contents*

But the serve fails.

```shell
 C:\Users\timof\repos\nx\my11> nx serve blog        
 ————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
 >  NX   Running target "blog:serve" failed
   Failed tasks:
   - blog:serve
   Hint: run the command with --verbose for more details.
```

Same error for build:  >  NX   Ran target build for project blog (1s)     ×    1/1 failed

How to solve 'eleventy' is not recognized as an internal or external command?

npm install @11ty/eleventy --save-dev

### Image paths

<img src="{{ 'assets/' + portraitData.newFileName }}" />

New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg:1          GET http://localhost:4200/assets/New_York_Rangers_December_11th_2010_Lundqvist-portrait.jpg 404 (Not Found)

How to fix this?

I think the easy way is to just use an assets directory that would already work for this app.  Not the lib, as there is no assets directory there, and I think it would be the same problem trying that.  The lib is used in the customer portal app where this is an assets directory.

It has a git keep file there also:

apps\customer-portal\src\assets\.gitkeep

What is that file for?  *A GITKEEP file is an empty file that Git users create so that a Git repository preserves an otherwise empty project directory. By convention, empty directories that contain no files are not committed to Git repositories.*

So instead of replacing this:

dist/apps/public/

with this (which doesn't work)

libs/shared-assets/assets/

Replace it with this:

apps/customer-portal/src/assets/

(node:14668) UnhandledPromiseRejectionWarning: Error: Input file is missing:dist/apps/public/Maiko_and_Reid.jpg

Why didn't the replace work?  I think maybe because I undid this file so that there is a trace later of the old filenames and it undid the entire global search and replace.

Do it again, and I saw the image for a brief moment, but then the Angular app refreshed?

Go through it again and, voila, the app refreshes.  That's a strange one.

Here is the log with preserve turned on:

```txt
this.portraitData {path: 'dist/apps/public/', fileName: 'Maiko_and_Reid.jpg', original: {…}, aspect: 'portrait', new: {…}, …}
2index.js:55 [WDS] App updated. Recompiling...
reloadApp.js:50 [WDS] App updated. Reloading...
Navigated to http://localhost:4200/trends
```

Can anyone guess what's going on?  I can.  All the files in that directory are watched, and the app recompiles on change.  How to exclude that directory?

On [this SO answer](https://stackoverflow.com/questions/39869292/angular2-angular-cli-exclude-folders-from-automatic-build-watchers), someone seems to be asking the same question, to which user Ced
 with 14.2k reputation points says: "your app folder really isn't the place to upload user content"

And, I can't find any other valid answer.  This might be a real issue!  Maybe the shared-assets is the solution that has to work.

The other possible option is using another S3 bucket and keep replacing the files there.

Or can we make a service to send the images from another directory to the front-end to display.

Yes, that might be the easiest option, as [described in this SO answer](https://stackoverflow.com/questions/58683457/how-to-return-an-image-to-the-client-using-nest-js-framework).

Use a public directory to serve the images from.  This is the example code:

```js
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.use('/public', express.static(join(__dirname, '..', 'public'))); // <-
  await app.listen(3000);
}
```

This [SO second answer by Abhay reputation 5,722](https://stackoverflow.com/questions/63429380/how-to-serve-static-images-in-nestjs) shows two methods.  The first uses the app.module.  We need this first:

npm i --save @nestjs/serve-static

Then this:

```js
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, '..', 'public'),
    }),
```

Then we need a public directory.   Oh, we already have that.  It's empty.

However, the method to use it is not shown.  I would imaging one of these would work:

http://localhost:3333/public/Colorado_Avalanche_Playoffs%21.jpg

http://localhost:3333/Colorado_Avalanche_Playoffs%21.jpg

But I see a bunch of errors:

```err
[Nest] 9656   - 09/06/2022, 7:51:38 am   [ExceptionsHandler] ENOENT: no such file or directory, stat 'C:\Users\timof\repos\satisfactory\dist\apps\public\index.html' +71ms
Error: ENOENT: no such file or directory, stat 'C:\Users\timof\repos\satisfactory\dist\apps\public\index.html'
```

I can enter this in the browser to see the image there:

C:\Users\timof\repos\satisfactory\public\Colorado_Avalanche_Playoffs%21.jpg

If the server was not running, that would work anyway, right?

So I suppose one way to make this work is to use an absolute path method.

Anyhow, we need to revert the directory change.

From this:

apps/customer-portal/src/assets/

to this again:

dist/apps/public/

Or should we use our new lib hoping one day it can actually be a shared lib for assets when we find out how to do it?

libs/shared-assets/assets/

If that dir that it's looking for is created: dist\apps\public\ and used like this:

http://localhost:3333/dist/apps/public/Colorado_Avalanche_Playoffs%21.jpg

Still fails with the same error.  It's looking for a static website, not images.  Maybe it needs a config for image types?

[This SO has the same issue](https://stackoverflow.com/questions/68019001/how-to-get-serve-static-images-nestjs).  There are two answers there that seem to contradict themselves.

After using answer one, the error changes:

http://localhost:3333/dist/apps/public/Colorado_Avalanche_Playoffs%21.jpg

In the browser now, we see a 404 instead of a 500.

{"statusCode":404,"message":"Cannot GET /dist/apps/public/Colorado_Avalanche_Playoffs%21.jpg","error":"Not Found"}

No error in the node console.

Reading everything on StackOverflow and playing around with the config:

```js
    ServeStaticModule.forRoot({
      rootPath: join('/public'),
      serveRoot: '/public',
    }),
```

```txt
    at next (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\route.js:137:13)
    at Route.dispatch (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\route.js:112:3)
    at Layer.handle [as handle_request] (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\layer.js:95:5)
    at C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\index.js:281:22
    at param (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\index.js:354:14)
    at param (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\index.js:365:14)
    at Function.process_params (C:\Users\timof\repos\satisfactory\node_modules\express\lib\router\index.js:410:3)   
```

[Nest] 5060   - 11/06/2022, 7:29:22 am   [ExceptionsHandler] path must be absolute or specify root to res.sendFile +25407ms
TypeError: path must be absolute or specify root to res.sendFile

Another method would be to put this in the main.ts file:

```ts
  app.useStaticAssets(join(__dirname, '..', 'public'), {
    index: false,
    prefix: '/public',
  });
```

Looking at that that path translates to:

C:\Users\timof\repos\satisfactory\dist\apps\public

Still doesn't help.  But then I found [this SO](https://stackoverflow.com/questions/69552133/static-images-not-showing-in-handlebars-email-templates-using-nestjs) that does seem to work.  There actually was no answer, but the asker showed using setBaseViewsDir, and then, the public dir gets served:

```ts
  app.useStaticAssets(join(__dirname, '..', 'public'), {
    index: false,
    prefix: '/public',
  }); 
  app.setBaseViewsDir(join(__dirname, '..', 'public'));
  console.log('public directory: ', join(__dirname, '..', 'public'));
```

A note about this.  Those functions weren't available from app using this:

```ts
const app = await NestFactory.create(AppModule);
```

I had to change it to this (thanks to the issue [here](https://github.com/nestjs/nest/issues/2354)):

```ts
const app = await NestFactory.create<NestExpressApplication>(AppModule);
```

Now time for another search and replace.

Change this:

apps/toonify/src/test_img/

to this

dist/apps/public/

Yes siree!  Still not working.  Is this the way to reference those files?

```html
<img src="{{ 'dist/apps/public/' + portraitData.newFileName }}" />
```

or this:

```html
<img src="{{ 'C:/Users/timof/repos/satisfactory/dist/apps/public' + portraitData.newFileName }}" />
```

The second one I think.  Anyhow what's the exclamation mark doing in the file name now?

(node:21116) UnhandledPromiseRejectionWarning: Error: Input file is missing: dist/apps/public/Colorado_Avalanche_Playoffs!.jpg

Not sure how that's getting there, but our filename creation function that we talked about earlier comes to mind.

The file chosen seems to be OK.

Request URL: http://localhost:3333/api/image/Colorado_Avalanche_Playoffs%21.jpg

getImageMetadata is failing.

That would be from the findOne function.  The file name is:

Colorado_Avalanche_Playoffs%21.jpg

So the encoded ! (%21) is the issue.

To encode or not encode, that is the question.

The console running Node shows the !, but the console in the browser shows the %21.

Just to confirm, tried another image and the directory is used correctly to create the cropped image.  But the rabbit hole goes even deeper:

core.js:5601 WARNING: sanitizing unsafe URL value C:/Users/timof/repos/satisfactory/dist/apps/publicScreenshot 2022-06-11 110604-portrait.png (see https://g.co/ng/security#xss)
_sanitizeUrl @ core.js:5601
ɵɵsanitizeUrl @ core.js:5963
elementPropertyInternal @ core.js:10000
ɵɵpropertyInterpolate1 @ core.js:15538
ɵɵpropertyInterpolate @ core.js:15501
ImagePreviewComponent_mat_grid_list_2_div_11_Template @ image-preview.component.html:17
executeTemplate @ core.js:9575
refreshView @ core.js:9441
...
Show 153 more frames
unsafe:C:/Users/timof/repos/satisfactory/dist/apps/publicScreenshot 2022-06-11 110604-portrait.png:1
GET unsafe:C:/Users/timof/repos/satisfactory/dist/apps/publicScreenshot 2022-06-11 110604-portrait.png net::ERR_UNKNOWN_URL_SCHEME

But there is a broken image icon in the template.  Whoops, forgot the slash after public there.

C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot 2022-06-11 110604-portrait.png

This is actually an error and is blocked.

unsafe:C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot 2022-06-11 110604-portrait.png:1
GET unsafe:C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot 2

That path works in the browser.

Trying the same file again later, no cropped image is generated.  And still, no image showing up in the template, so we are still not out of the woods yet.

ImageService.findOne: imagePath dist/apps/public/Screenshot%202022-06-11%20110604.png
(node:20684) UnhandledPromiseRejectionWarning: 
Error: Input file is missing: dist/apps/public/Screenshot%202022-06-11%20110604.png

The file in question:

C:\Users\timof\repos\satisfactory\dist\apps\public\Screenshot 2022-06-11 110604.png

Maybe we need to *un-encode* it?  Or just remove the encode on the findOne, then it works.  But the template still wont show it:

unsafe:C:/Users/timof/repos/satisfactory/dist/apps/public/SafeValue must use [property]=binding: Screenshot 2022-06-11 110604-portrait.png (see https://g.co/ng/security#xss):1          GET unsafe:C:/Users/timof/repos/satisfactory/dist/apps/public/SafeValue must use [property]=binding: Screenshot 2022-06-11 110604-portrait.png (see https://g.co/ng/security net::ERR_UNKNOWN_URL_SCHEME

This works to make the error go away, but I'm still not seeing the file:

<img [innerHTML]="'C:/Users/timof/repos/satisfactory/dist/apps/public/' + portraitImg" />

C:/Users/timof/repos/satisfactory/dist/apps/public/SafeValue must use [property]=binding: Screenshot 2022-06-11 110604-portrait.png (see https://g.co/ng/security#xss)

Even using trusted bypass security doesn't work:

Not allowed to load local resource: file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png

http://localhost:4200/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png 404 (Not Found)

Oh, right, duh.  The server is running on port 3333.

Screenshot%202022-06-11%20110604-portrait.png:1
GET http://localhost:3333/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png 404 (Not Found)

Whoops.

GET http://localhost:3333/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png 404 (Not Found)

The filename is still encoded.  And, it should be a file, not a server call.

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png

That works in the browser.

No, we do have to user the server, remember?

Something like this works:

```ts
  getSafeUrl() {
    this.portraitImg = 'http://localhost:3333/public/' + newFileName;
    return this.sanitizer.bypassSecurityTrustResourceUrl(this.portraitImg);
  }
```

Yay!

### Past tense

Kelly Slater is a good example of where the tense is a news story, but we want the tense of a painting label.

"Kelly Slater has won for an eighth time at Pipeline, 30 years after his first victory at the famous surf break in Hawaii."

Should be:

"Kelly Slater won for an eighth time at Pipeline, 30 years after his first victory at the famous surf break in Hawaii."

Here's [a start](https://stackoverflow.com/questions/62945590/how-can-i-transform-verbs-from-present-tense-to-past-tense-with-using-nlp-librar)

And what should the title be?

### Failed Bart calls

bart.service.getArticleSummary: articleUrl https://www.seventeen.com/celebrity/a40255755/cooper-noriega-dies-age-19/
bart.service getArticleSummary service err No model was supplied, defaulted to sshleifer/distilbart-cnn-12-6 (https://huggingface.co/sshleifer/distilbart-cnn-12-6)

### Error caught at Subscriber [object Object]

When posting the Cooper Noriega post, saw this in the browser console:

trends.component.ts:223: Error caught at Subscriber [object Object]

However, the post did work.

### Trends by country

It's always interesting to see the same trend show up for two countries.

```txt
US trend: 500K+ Cooper Noriega
AU trend: 20K+ Cooper Noriega
```

That's 4% I believe.

The next day, the poor teen is a trend also:

US: Cooper Noriega death (200K+ searches)
AU: Cooper Noriega (50K+ searches)

That's 25%.  That's a good ball-park range I suppose.

### Showing the whole image

Using the mat-grid doesn't seem to work very well.  It would be nice to use a background image but even outside the grid, this dynamically setting the bg doesn't seem to work.

<div *ngIf="portraitData" class="image_container" [style.backgroundImage]="'url('+getSafeUrl+')'">

This doesn't work either:

[ngStyle]="'url('+getSafeUrl()+') no-repeat 0 0 / cover'">

### Proper aspects

The aspect ration for the unfortunate teenager is 1.364321608040201

original height: 796
original width: 1086

Currently it looks like we are creating a landscape image.

new height: 640
new width: 873

Linked In landscape should be 1200 x 627 and Portrait 627 x 1200.  So that's just switching the height and width.

Instagram landscape 1080 x 566
Instagram portrait 1080 x 1350

Here the width is constant.

So that should be the starting point.

After a bit of work, things seem to be as they should.

story_dog2_portrait.jpg  720 x 960
story_dog2_landscape.jpg 720 x 541
story_dog2_square.jpg 720 x 720

Portrait 720x982
landscape 738x541
square 720x720

The portrait looks a little off.

### reference broken

What's this all about?

```txt
PS C:\Users\timof\repos\satisfactory> git push
Counting objects: 100% (43/43), done.
Delta compression using up to 8 threads
Compressing objects: 100% (21/21), done.
Writing objects: 100% (22/22), 3.04 KiB | 622.00 KiB/s, done.
Total 22 (delta 17), reused 0 (delta 0)
remote: Resolving deltas: 100% (17/17), completed with 17 local objects.
To https://github.com/timofeysie/satisfactory.git
   cc4de06..1ca2770  develop -> develop
error: update_ref failed for ref 'refs/remotes/origin/develop': cannot lock ref 'refs/remotes/origin/develop': unable to resolve reference 'refs/remotes/origin/develop': reference broken
PS C:\Users\timof\repos\satisfactory> git status
On branch develop
Your branch is based on 'origin/develop', but the upstream is gone.
  (use "git branch --unset-upstream" to fixup)

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   apps/nest-demo/src/app/image/image.service.ts
        modified:   docs/worklogs/2022-06.md
        modified:   libs/trends/src/lib/components/topic-form/topic-form/topic-form.component.scss
        modified:   libs/trends/src/lib/containers/image-preview/image-preview.component.html
        modified:   libs/trends/src/lib/containers/image-preview/image-preview.component.scss
Delta compression using up to 8 threads
Compressing objects: 100% (26/26), done.
Writing objects: 100% (27/27), 5.23 KiB | 1.05 MiB/s, done.
Total 27 (delta 17), reused 0 (delta 0)
remote: Resolving deltas: 100% (17/17), completed with 17 local objects.
To https://github.com/timofeysie/satisfactory.git
   1ca2770..03ca66b  develop -> develop
error: update_ref failed for ref 'refs/remotes/origin/develop': cannot lock ref 'refs/remotes/origin/develop': unable to resolve reference 'refs/remotes/origin/develop': reference broken
```

The last to commits do not seem to be on github:

```txt
commit 03ca66b5ccbe6fa74f3f05a9426450021c71e00a (HEAD -> develop)
Author: tim_curchod <timofeyc@hotmail.com>
Date:   Sun Jun 12 20:52:52 2022 +1000

    aspect poster images generated and shown in the template

commit 1ca27703d15030636d23359e67ce443bc5418876
Author: tim_curchod <timofeyc@hotmail.com>
Date:   Sat Jun 11 21:57:45 2022 +1000

    fixed the initial poster image display issue

commit cc4de06434048fd84b3b007274244b081a31df69
Author: tim_curchod <timofeyc@hotmail.com>
Date:   Sat Jun 11 13:04:30 2022 +1000

    added failed shared assets and started using a public directory instead
```

However, I was able to create a merge request with the latest from develop into master.

I created a new temp dev branch "new-dev" and pushed it just to make sure it was on the remote before that just in case.

Then, switching back to develop, saw this:

```txt
PS C:\Users\timof\repos\satisfactory> git checkout develop
Switched to branch 'develop'
M       docs/worklogs/2022-06.md
Your branch is based on 'origin/develop', but the upstream is gone.
  (use "git branch --unset-upstream" to fixup)
PS C:\Users\timof\repos\satisfactory> git branch --unset-upstream
```

Did that, and then had to do this again to re-instate what's going on.

git push --set-upstream origin develop

Most strange.  Anyhow, GitHub shows the latest commits now on develop, so ...

### Automatically center posters

This should be an easy one.  But it's not.  Out of the box (first attempt), this is what is being calculated:

aspect: portrait type: width length: 720 originalLength: 1086 spaceRemaining: 366 newLength: 183

But the portrait appears like that offset is not being used.  How to see what Sharp is using?

This is being sent to the backend:
height: 982
left: 183
top: 0
width: 720

So that's correct.

I am seeing this error on some of them:

ImageService.create: err creating Screenshot 2022-06-11 110604-portrait.png [Error: extract_area: bad extract area]

But on the portrait crop, it's not there:

ImageService.create: done creating Screenshot 2022-06-11 110604-square.png

I made the error logging one line because there are three async operations happening at once, so actually you can't assume that the error in question comes right after the logging for the details before it.  Here is the verification:

ImageService.create: err creating aspect portrait Screenshot 2022-06-11 110604-portrait.png [Error: extract_area: bad extract area]

It might be because we are not giving it whole numbers:

```txt
ImageService.create {
  path: 'dist/apps/public/',
  fileName: 'Screenshot 2022-06-11 110604.png',
  original: { width: 1086, height: 796 },
  aspect: 'landscape',
  new: { left: 0, top: 63.75, width: 738, height: 541 }
}
ImageService.create: imagePath dist/apps/public/Screenshot 2022-06-11 110604.png
[Nest] 14680   - 13/06/2022, 10:50:37 am   [ExceptionsHandler] Expected integer for top but received 63.75 of type number +57ms
```

  new: { left: 92, top: 0, width: 720, height: 982 }

  720 + 92 - 812

This is not greater than the original width 1086.  Si why the error?

My understanding is that, start 92 pixels in, extract 720 pixels from there, which leaves the rest.

1086 - 738 = 348 / 2 = 174.  So actually, the left should be 174.  The top for portrait should be 0, or what?

Wait, I think it's the height.  I fixed the width at 20 and look:

  original: { width: 1086, height: 796 },
  aspect: 'portrait',
  new: { left: 20, top: 0, width: 720, height: 982 }

If we have an image that is 1086 x 796, the the height should be 796 and thw width needs to be calculated by the aspect.

The deal is like this:

* Divide the original height by the original width for the portrait ratio.
* Divide the original width by the original height for the landscape ratio.

The standard offset of original length - (new length / 2) can be applied to all aspects.

The initial implementation was complicated and took a while to get to work.  Now it's working and it has a little of the uncomfortable baggage from the initial attempt.  But there will be time more to refactor, as the next task for this component will further refine it.

### Scroll bars for the offset

This is a better idea than the text inputs that were planned.  Shouldn't be too much extra work.  After all, a slider is a kind of input.  Think of it as two sliders, one horizontal, and one vertical.

[The material docs](https://material.io/components/sliders#specs) don't have exactly what we want.  In fact, they may have a show stopper:

*Sliders shouldn’t be used to adjust settings with any delay in providing user feedback.*

Just a normal html version would be fine.  We can use min/max values to show the available space for the crop to move in.  Somewhere said *the [type="range"] spec includes a multiple attribute*. but I don't think that is just for html.

Maybe we could just use scroll bars?  Probably we should have designed this so that yes, it's just a large image in a cropped div with scroll bars.  Then when the user kicks off the image generation, the values of the scroll bars are used to create the files to use with the models.

Too late now I suppose?  Or doable?  Instead of showing the generated images, just show the draggable image.  No need to generate the files again on each change.

That would mean that the values and range offsets will all be done in css.  Very interesting!

https://stackoverflow.com/questions/71939935/css-scale-and-centre-image-within-scrollable-container-without-cropping

### Current issues

Landscape is 583 x 541.  It should be a lot wider.

Also, the offsets are being calculated using the  current length.

orig len: 1086 - 1086 = 0 / 2 = 0
image-preview.component.ts:166 orig len: 796 - 541 = 255 / 2 = 128

Things seem out of order.  Refactoring needed.

### Turn off the automatic image generation

When an image is selected and the user goes to "Create post", the image is automatically downloaded and then the art generation kicks in.  But during testing, this is not what we want.  We have a button to start that, so time to remove this old feature.

Where does that happen?  Backend or front end?

It starts here: (click)="handleShowForm.emit()"

That goes here, to the main container:

libs\trends\src\lib\containers\trends\trends.component.ts

  <demo-app-trends-toolbar
    ...
    (handleShowForm)="onHandleShowForm()"

  onHandleShowForm() {
    this.preFillForm();
  }

That function calls among other things, this one:

this.downloadImages();

Which calls the service (no result expected, we may want to change that now):

this.trendsService.downloadImages(urls[i]).subscribe();

That does this:

.post<any>('http://localhost:3333/api/gan', { ...

It's all done in this controller: apps\nest-demo\src\app\gan\gan.controller.ts

@Post() async downloadImage(@Body() linkWrapper: any) {

All we need to do is comment out the part after the downloaded file is written, and test it out.

OK, so that's done.  Next issue is that when selecting images in the first page, then the images don't show up when the original image is chosen on the post creation page.

The response from the Angular service indicates a complete download from the GAN service in the network tab:

Request URL: http://localhost:3333/api/gan
Request Method: POST
Status Code: 201 Created

But this is in the browser console log:

trends.service.ts:67 downloadImages 2 - Error:  
HttpErrorResponse {headers: HttpHeaders, status: 201, statusText: 'Created', url: 'http://localhost:3333/api/gan', ok: false, …}
error: {error: SyntaxError: Unexpected token d in JSON at position 0 at JSON.parse (<anonymous>) at XMLHtt…, text: 'download complete Spalding_Basketball.jpg'}
headers: HttpHeaders {normalizedNames: Map(0), lazyUpdate: null, lazyInit: ƒ}
message: "Http failure during parsing for http://localhost:3333/api/gan"
name: "HttpErrorResponse"
ok: false
status: 201
statusText: "Created"
url: "http://localhost:3333/api/gan"

error: SyntaxError: Unexpected token d in JSON at position 0 at JSON.parse (<anonymous>) at XMLHttpRequest.onLoad (http://localhost:4200/vendor.js:26762:51) at ZoneDelegate.invokeTask (http://localhost:4200/polyfills.js:10300:31) at Object.onInvokeTask (http://localhost:4200/vendor.js:56361:33) at ZoneDelegate.invokeTask (http://localhost:4200/polyfills.js:10299:60) at Zone.runTask (http://localhost:4200/polyfills.js:10072:47) at ZoneTask.invokeTask [as invoke] (http://localhost:4200/polyfills.js:10381:34) at invokeTask (http://localhost:4200/polyfills.js:11494:14) at XMLHttpRequest.globalZoneAwareCallback (http://localhost:4200/polyfills.js:11531:21)
text: "download complete Spalding_Basketball.jpg"

We need to return json I think.

That done, it seem like if the page is not refreshed, then the chosen original image will not show up in the template.

I think we need some change detection fiddling there.

### The scrollable image for cropping

We might want to settle in for another few weeks of this feature.  What is needed is to constrain the image with the particular aspect's dimensions, but show the original image in the container.  Then, scroll the image so that the position matches the cropped image.  Then, when the user moves the image around and centers it to how they want, recalculate the offsets and when they are all happy with that, choose some "generate posters" button to finalize that.

I don't know how to do a lot of that off the top of my head, so there will be googling.  There will be blood.

First, so we don't have to keep downloading new images to work with, let's do the todo item:

### Add chosen original to the preview section

Is this it?

[innerHTML]="fullTopicForm.value.one.commonImg"

The problem is, when we choose an original image to create the poster from, it could be from any kind of image in the public download directory.

Where does the original image get stored on selection?

It's an [imageFileName] input for the image-preview.component.

That comes from here:

fullTopicForm.value.one?.imageChosen

So add that where the commonImg should be.  But it fails:

```txt
fileChose Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg
trends.service.ts:123 getImageMetadata: fileName Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg
Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg:1          Failed to load resource: the server responded with a status of 404 (Not Found)
Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg:1          Failed to load resource: the server responded with a status of 404 (Not Found)
Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg:1          GET http://localhost:4200/Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg 404 (Not Found)
```

Where is that file?

Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg

In our public dir, there is only this file:

public\Colorado_Avalanche_Playoffs%21.jpg

Wait, this is the file:

dist\apps\public\Church_of_the_Atonement_%28Crooksville%2C_Ohio%29_-_exterior_2.jpg

How does the file get accessed again?

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Screenshot%202022-06-11%20110604-portrait.png

So maybe we should append that path?

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/

Not allowed to load local resource:
file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg

Wait there is a difference:

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Drake_at_The_Carter_Effect_2017_%252836818935200%2529_%2528cropped%2529.jpg

There is some extra encoding happening there.

The % is being turned into %25.  So call encode url on that.  But still the error:

trends:1 Not allowed to load local resource: 
file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Drake_at_The_Carter_Effect_2017_%252836818935200%2529_%2528cropped%2529.jpg

This time at least the file exists:

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/Drake_at_The_Carter_Effect_2017_%252836818935200%2529_%2528cropped%2529.jpg

This was working before, right?

I don't know if it's the files being used or not, but the image preview component is not working at all now.  It might have something to do with this:

(node:14488) UnhandledPromiseRejectionWarning: Error: Input file is missing: dist/apps/public/Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg
(node:14488) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 10)

Just because this url works (it would work even without the server running) means nothing:

file:///C:/Users/timof/repos/satisfactory/dist/apps/public/

Time to follow the action from the file selector input to the backend again to see where the problem is.  I'm guessing it's the last mile where the backend provides the meta data and the aspect poster images are generated, the filenames are available, and the template is not updating.

To make this kind of tracing quicker sometimes, there is a new file now called how-tos.md where I can put the tracing so that the next time someone needs to follow the trail, it's already done for them.

Here's what it looks like in logging form:

```txt
post-creation-form.component.ts:151 1
post-creation-form.component.ts:154 fileChose Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg
trends.component.ts:329 2 Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg
trends.service.ts:123 3 getImageMetadata: fileName Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg
```

Not sure why, but we are not getting anything from the image-preview.component ngOnInit lifecycle hook.

libs\trends\src\lib\containers\image-preview\image-preview.component.ts

```ts
  /**
   * Get the meta data from the original image from the backend api/image GET endpoint,
   * calculate the aspect details needed to crop the image and POST those which will
   * result in the particular aspect file asked for.
   */
  ngOnInit() {
    this._imageFileName.subscribe((fileName) => {
      console.log('ngOnInit', fileName);
      this.trendsService
        .getImageMetadata(fileName)
        .subscribe((sharpMetadata) => {
          console.log('4 getImageMetadata result');
          this.metaData = sharpMetadata;
          // setup initial offsets
          this.setupPosters(fileName, sharpMetadata, 'portrait');
          this.setupPosters(fileName, sharpMetadata, 'landscape');
          this.setupPosters(fileName, sharpMetadata, 'square');
        });
    });
  }
```

How do these regressions happen?

The API call is thus:

httpClient.get('http://localhost:3333/api/image/'

The problem indeed lies on the backend, due to the error suggested above.  I would guess now that it's an encoding issue.

ImageController.GET Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg
ImageService.findOne: imageName Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg
ImageService.findOne: imagePath dist/apps/public/Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg
(node:21588) UnhandledPromiseRejectionWarning: Error: Input file is missing: dist/apps/public/Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg

The file is saved with encoded properties.  In the input, we are getting an unencoded string.

The issue is, sometimes the filenames are already encoding, and encoding them again will cause the same issue.  Is there a way to tell if a string is already encoded?  We could just try both to see which one works, but if there is a cleaner way to do this, please teach us oh Overflow of the Google Stack.

The answer comes quickly: *Decode, compare to original. If it does differ, original is encoded. If it doesn't differ, original isn't encoded. Exception: When a string contains "+" character url decoder replaces it with a space even though the string is not url encoded* - Lonzak (8,594 reputation points).

The brackets are still not encoded.  Back to StackOverflow:

```txt
Based on encodeURIComponent docs by Mozilla: encodeURIComponent escapes all characters except A-Z a-z 0-9 - _ . ! ~ * ' ( )

So, the only characters we don't want to scape are: A-Z a-z 0-9.  This function does it:

function encodeUriAll(value) {
  return value.replace(/[^A-Za-z0-9]/g, c =>
    `%${c.charCodeAt(0).toString(16).toUpperCase()}`
  );
}
```

dist/apps/public/Drake_at_The_Carter_Effect_2017_(36818935200)_(cropped).jpg

That then creates this:
Drake%5Fat%5FThe%5FCarter%5FEffect%5F2017%5F%2836818935200%29%5F%28cropped%29%2Ejpg

The actual file:
Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg

This might be the regex we want: /[\(\)]/g

This works to get us to the cropping service.  As a side not, TypeScript says both those \ characters are unnecessary, so I added this above the regex:

 eslint-disable-next-line no-useless-escape

Next, no cropped files are written.  Look at this:

```txt
ImageService.create: done creating Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-landscape.jpg {
  path: 'dist/apps/public/',
  fileName: 'Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg',
  original: { width: 690, height: 956 },
  aspect: 'landscape',
  new: { left: 0, top: 208, width: 1325, height: 541 }
}
ImageService.create: err creating aspect landscape 
Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-landscape.jpg [Error: extract_area: bad extract area
```

So we need to use the same function there.

These get called *a lot*:

this.squareImg http://localhost:3333/public/Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-square.jpg

Even though there are no files there.

After adding the isEncoded(imageName) {} and encodeUriAll(value) {} fixes to both the GET and POST services, the original image is gotten and displayed.  But looks like the same thing has to be done for the cropped aspect images.

### Cropped aspect images regression

They were working, and they may still be with the right files without special characters.  We want all files to work.  So here we go.

Currently, we see this in the browser console:

Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-portrait.jpg:1
Failed to load resource: the server responded with a status of 404 (Not Found)

What does the server say?

ImageService.create: err creating aspect square Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-square.jpg 
[Error: extract_area: bad extract area]

Here is the dto:

ImageService.create: done creating Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-square.jpg {
  path: 'dist/apps/public/',
  fileName: 'Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg',
  original: { width: 690, height: 956 },
  aspect: 'square',
  new: { left: 0, top: 118, width: 720, height: 720 }

So yeah, the original file width is 690, but we are using 720.  This is actually a front end issue.  I think the dimensions from the dog demo were used as the minimum, but if the original is less than those, then we need to use the original dimensions.

There seems to be something fishy about this:

```ts
      if (originalHeight > 720) {
        if (originalHeight < 720) {
          height = originalHeight;
        } else {
          height = 720;
        }
      }
```

Isn't this a little better:

```ts
      if (originalHeight > 960) {
          height = 960;
      } else {
        height = originalHeight;
      }
```

Still, that is called a lot for various aspects and presets.  How about a reusable function there?

How about getting it to work first.  Currently, we are still seeing the error:

ImageService.create: done creating Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-landscape.jpg {
  path: 'dist/apps/public/',
  fileName: 'Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29.jpg',
  original: { width: 690, height: 956 },
  aspect: 'landscape',
  new: { left: 0, top: 208, width: 1325, height: 541 }
}
ImageService.create: err creating aspect landscape Drake_at_The_Carter_Effect_2017_%2836818935200%29_%28cropped%29-landscape.jpg 
[Error: extract_area: bad extract area]

How does that width get so big?  The original image is indeed 690 by 956.  So our landscape formula is psycho.  The whole thing needs to use the original width if it's greater than 720.  If it's less than 720, then the original width should be used, and the calculations done on that width so that the height gets constrained.

The issue is with the getAspectRatio() function, and/or how it's used.  Limiting the square to it's shortest length fixes that aspect at least.

The server is then throwing this Error: Expected integer for width but received undefined of type undefined.

But I don't see any undefined values in the post body.  The stack trace says:

 at ImageService.create (C:\Users\timof\repos\satisfactory\dist\apps\nest-demo\webpack:\apps\nest-demo\src\app\image\image.service.ts:43:8)

   original: { width: 690, height: 956 },
  aspect: 'landscape',
  new: { left: 0, top: 208, height: 498 }

That would be top + height

I'm not sure why the height is there, when it could be for portrait or landscape.  But indeed, there should be both height and width, so one is undefined.  So trace back how that body gets created. I believe it's the image POST api call.

Start at the preparePostBody() function.

After a bit, the landscape looks like a better version of portrait.
new:
height: 750
left: 0
top: 206
width: 541
original:
height: 956
width: 690

I think there is actually a confusion about using a ratio.  We don't just want a smaller version of the current image.  We want to crop it to the same dimensions as the dog demo if the image is large enough.  If it's not, then we want to use the dimensions of the dog demo to reduce one of the sides so that it's the same size.  If the image is shorter on both directions, then we can use the aspect to also generate both of those.

Good to get that straight.  A contributor to AMP said"

*The poster image should be in 3x4 aspect ratio for portrait, 4x3 for landscape, and 1x1 for square.*

Those are the ratios we should be using, not the one based on the original image size.

So what is this?

image-preview.component.ts:234 orig len: 956 - NaN = NaN / 2 = NaN

### the mysterious get items()

Previously we had this in the image-preview.component.ts class:

```ts
  get items() {
    return this._imageFileName.getValue();
  }
```

However, there is no items, there is no get items.  I was thinking why this is even there.  I thought how did the load original image even work.  I changed it to what I thought it should be, and TypeScript said getters and setters had to be next to each other, so moved it here:

```ts
  @Input() set imageFileName(value: string) {
    this._imageFileName.next(value);
  }
  get imageFileName() {
    return this._imageFileName.getValue();
  }
```

However, the problem with loading the original image turned out to be encoding or not encoding, so the jury is still out as to what exactly is needed for the getter and the setters here.  My gut feeling is that, it was there by mistake before, and does nothing now.
