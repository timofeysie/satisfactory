# 2122-01

## The failing summaries

It seems like if a particular search fails then

```txt
The id is for Lance Stephenson:
fullUrl https://commons.wikimedia.org/w/index.php?search=Lance Stephenson&title=Special:MediaSearch&go=Go
loadSummary [{'summary_text': ' There is no new episode of Saturday Night Live tonight . NBC did confirm this past week that there will be a new episode airing on January 15 with West Side Story star Ariana DeBose as the host . The plan here is for there to be other episodes airing later on in the month, but we�ll have to
wait and see on some of those .'}]
```

Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summary.txt'
id Lance Stephenson
fullUrl https://commons.wikimedia.org/w/index.php?search=Lance Stephenson&title=Special:MediaSearch&go=Go  
list 28
bart.controller: getArticleSummary
bart.service getArticleSummary
bart.service getArticleSummary service err No model was supplied, defaulted to sshleifer/distilbart-cnn-12-6 (https://huggingface.co/sshleifer/distilbart-cnn-12-6)

loadSummary
loadSummary undefined
[Nest] 14304 - 09/01/2022, 10:00:16 pm [ExceptionsHandler] ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summary.txt' +178734ms
Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summary.txt'

It worked in an incognito browser, so possibly caching issues?

Turns out we were calling the bart.py, but had made changes to goose.py to use only that script. Changing that brought back our summaries.

The OK, not OK error handling for goose and bart is still an issue however.

## srcset

The srcset field for two type artist does not expand like the input for one.

## <span class="padding">{{ article.timeAgo }}</span>

The cards are crowded. Added some margin.

## The snake

The trend detail article said:

```txt
WATCH: Mink drags snake across road in the Everglades
NBC2 News
X
COPELAND, Fla. – A pair of hikers caught the moment a mink crossed a road carrying a large snake in its mouth in Fakahatchee Strand Preserve State Park.
```

The bart goose said:

```txt
After failing field sobriety exercises, the 44-year-old was arrested and taken to the Naples Jail Center. The man was taken into custody after failing field\xa0obeseety\xa0exercises. He was taken to a local jail where he is being held on charges of DUI and possession of marijuana. The arrest occurred in Naples, Florida, at the time of the incident.
```

It seems like if must have gotten an ad for another story instead.

### Commit "fixed the srcset logic"

## Download images

Using the getCommonsImgSource() we get this commonsImgSource:
https://commons.wikimedia.org/wiki/File:Vanity_fair_%281900%29_%2814784495843%29.jpg

But really we want this full size image:
https://upload.wikimedia.org/wikipedia/commons/1/14/Vanity_fair_%281900%29_%2814784495843%29.jpg

From this:
<img src="https://upload.wikimedia.org/wikipedia/c…x-width: 2400px !important; max-height: 3040px;">

https://upload.wikimedia.org/wikipedia/commons/thu…ax-width: 2400px !important; max-height: 3040px;"', '']

"https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg/142px-Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg" data-src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg/142px-Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg" alt="Rand Paul, official portrait, 112th Congress alternate.jpg" loading="lazy" class="sd-image" style="height: 100% !important; max-width: 2400px !important; max-height: 3040px;""

https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg

This is the data-src:
https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg/142px-Rand_Paul%2C_official_portrait%2C_112th_Congress_alternate.jpg

https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Vladimir_Kokkinaki_1939.jpg/138px-Vladimir_Kokkinaki_1939.jpg

We want this:

https://upload.wikimedia.org/wikipedia/commons/1/1a/Thanasi_Kokkinakis_%2824153413030%29.jpg

Where is that here?

urlPage <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Thanasi_Kokkinakis_%2824153413030%29.jpg/216px-Thanasi_Kokkinakis_%2824153413030%29.jpg" data-src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Thanasi_Kokkinakis_%2824153413030%29.jpg/216px-Thanasi_Kokkinakis_%2824153413030%29.jpg" alt="Thanasi Kokkinakis (24153413030).jpg" loading="lazy" class="sd-image" style="height: 100% !important; max-width: 3679px !important; max-height: 3063px;">

https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Thanasi_Kokkinakis_%2824153413030%29.jpg

/216px-Thanasi*Kokkinakis*%2824153413030%29.jpg - /thumb =

https://upload.wikimedia.org/wikipedia/commons/1/1a/Thanasi_Kokkinakis_%2824153413030%29.jpg

What about .png file extensions?

I created a kind of embarrassing function called findExtension() which looks for the third dot in the img tag string and returns that with the dot, such as '.jpg' or '.png'.

Seems to work OK, until it doesn't...

## 17th

Chrome:

```txt
Request URL: http://localhost:3333/api/images/Australian%20Open
Referrer Policy: strict-origin-when-cross-origin
```

Node:

```txt
...
[Nest] 4424   - 17/01/2022, 9:43:40 pm   Listening at http://localhost:3333/api +15ms
No type errors found
Version: typescript 4.2.4
Time: 11466ms
id Jordan Cashmyer
fullUrl https://commons.wikimedia.org/w/index.php?search=Jordan Cashmyer&title=Special:MediaSearch&go=Go
list 0
gan.controller: downloadImage
links undefined
Error: connect ECONNREFUSED 127.0.0.1:443
    at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1148:16)
```

StackOverflow:

```txt
You should use the link name (by default, the name of the linked service) as the hostname to connect to.
So just use host: 'db' instead of host: 'localhost'
```

## 18th

Fixed the issue with the truncated urls. This was due to a title with a dot in it.

This issue also turned up:

This is the summary created by the server:

```txt
loadSummary [{'summary_text': ' Calvin Kattar defeats Giga Chikadze by unanimous decision in featherweight fight . Jake Collier submits Chase Sherman in the co-main event . Kaitlyn Chookagian defeats Jennifer Maia in a rematch in a women\'s flyweight title rematch . Kattagian and Maia met in 2019; the
"Blonde Fighter" won a rematch last year .'}]
```

But the form gets pre-filled like this:

```txt
won a rematch last year.
```

And, the url download is causing this error:

```txt
gan.controller: downloadImage
links https://upload.wikimedia.org/wikipedia/commons/6/65/1971_Chrysler_Valiant_%28VG%29_Regal_Safari_station_wagon_%282015-07-10%29_02.jpg
(node:11936) UnhandledPromiseRejectionWarning: Error: Request Failed With a Status Code: 403
    at ClientRequest.<anonymous> (C:\Users\timof\repos\timofeysie\satisfactory\dist\apps\nest-demo\webpack:\apps\nest-demo\src\app\gan\gan.service.ts:22:24)
```

The url works in the browser indicating that this is a cors issue.

But we already use the setting in our nest app: app.enableCors();

I then used a different approach to the https lib.

```js
  @Post()
  async downloadImage(@Body() linkWrapper: any) {
    const name = this.parsePath(linkWrapper.links[0]);
    console.log('gan.controller: downloadImage', name);
    const writer = fs.createWriteStream('apps/toonify/src/test_img/'+name.filename);
    const response = await this.httpService.axiosRef({
      url: linkWrapper.links[0],
      method: 'GET',
      responseType: 'stream',
    });
    response.data.pipe(writer);
    return new Promise((resolve, reject) => {
      writer.on('finish', resolve);
      writer.on('error', reject);
    });
  }
```

## 22

The hugging face output needs to also use the name of the file so that a call for a particular topic brief will result in the correct file being loaded, not whichever was last time if there was an error.

Just using something from the json as the file name would work.

Here is what the json looks like:

```json
{
  "title": "Naomi Osaka defeated by Amanda Anisimova at Australian Open ...",
  "timeAgo": "2h ago",
  "source": "ABC News",
  "image": {
    "newsUrl": "https://www.abc.net.au/news/2022-01-21/australian-open-ash-barty-wins-naomi-osaka-amanda-anisimova/100774764",
    "source": "ABC News",
    "imageUrl": "https://t1.gstatic.com/images?q=tbn:ANd9GcQueliwziIoIBz2XL_Ot6rZE1U9yQbm-R4SLR94mH_53HWNAmJnTz2aVsJ3m0Agld7GuwxFL3Os"
  },
  "url": "https://www.abc.net.au/news/2022-01-21/australian-open-ash-barty-wins-naomi-osaka-amanda-anisimova/100774764",
  "snippet": "Ash Barty will face Amanda Anisimova in the last 16 after the unseeded American ended Naomi Osaka&#39;s Australian Open title defence in a gripping three-set&nbsp;..."
}
```

We really need to start collecting the date.

This is not hacking it: date=now+7-d

While we are here, we also need to capture the originalTrendTitleUsed to create the description.

That title is what we should use for the file name.

"Naomi Osaka defeated by Amanda Anisimova at Australian Open ..."

We will save that property, and use it for the filename like this

originalTrendTitleUsed: "Naomi Osaka defeated by Amanda Anisimova at Australian Open ..."
Naomi Osaka defeated by Amanda Anisimova at Australian Open.txt

Or should the ellipsis be used? Is that OK for a filename?

Naomi Osaka defeated by Amanda Anisimova at Australian Open ....txt

I'm thinking that we should use just the current setup which uses the url to the source.

event https://www.cnn.com/2022/01/21/entertainment/meat-loaf-obit/index.html

So the filename on the backend would be

https://www.cnn.com/2022/01/21/entertainment/meat-loaf-obit/index.html.txt

If that actually works, and there are no errors going to be caused by that in the future, then that's fine.

Currently it's summary.txt.

What is the save and what is the load api functions?

```ts
@Get() findAll() { return this.bartService.loadSummary(); }
@Get(':id') findOne(@Param('id') id: string) { return this.bartService.findOne(id); }
@Post() async getArticleSummary(@Body() article: any) { ... }
```

The bart.service.loadSummary() function needs to get the name.

Can we encode the url, send it to the get/id and then call loadSummary that way?

bart.service.getArticleSummary: path ./apps/nest-demo/src/app/bart/https://www.abc.net.au/news/2022-01-22/australian-open-alex-de-minaur-through-to-fourth-round/100775774.txt
process err [Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\https:\www.abc.net.au\news\2022-01-22\australian-open-alex-de-minaur-through-to-fourth-round\100775774.txt'] {
  errno: -4058,
  code: 'ENOENT',
  syscall: 'open',
  path: 'C:\\Users\\timof\\repos\\timofeysie\\satisfactory\\apps\\nest-demo\\src\\app\\bart\\https:\\www.abc.net.au\\news\\2022-01-22\\australian-open-alex-de-minaur-through-to-fourth-round\\100775774.txt'
}

Need to use the built-in encodeURIComponent(summaryUrl) function:

bart.service.getArticleSummary: path ./apps/nest-demo/src/app/bart/summaries/https%3A%2F%2Fwww.abc.net.au%2Fnews%2F2022-01-22%2Faustralian-open-alex-de-minaur-through-to-fourth-round%2F100775774.txt    
bart.controller.findAll
bart.service.loadSummary()

But the route is still using the get with no param.

Request URL: http://localhost:3333/api/bart/https%3A%2F%2Fwww.foxsports.com.au%2Ftennis%2Faustralian-open-2022-live-scores-results-night-6-updates-and-order-of-play-alex-de-minaur-marin-cilic-vs-andrey-rublev-jannik-sinner%2Fnews-story%2F1c2b6ea3e4216efd61727c19d511dcbe

404:

[Nest] 16136   - 23/01/2022, 1:17:46 am   [ExceptionsHandler] ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\https%3A%2F%2Fwww.foxsports.com.au%2Ftennis%2Faustralian-open-2022-live-scores-results-night-6-updates-and-order-of-play-alex-de-minaur-marin-cilic-vs-andrey-rublev-jannik-sinner%2Fnews-story%2F1c2b6ea3e4216efd61727c19d511dcbe.txt' +43956ms
Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\https%3A%2F%2Fwww.foxsports.com.au%2Ftennis%2Faustralian-open-2022-live-scores-results-night-6-updates-and-order-of-play-alex-de-minaur-marin-cilic-vs-andrey-rublev-jannik-sinner%2Fnews-story%2F1c2b6ea3e4216efd61727c19d511dcbe.txt'

The file exists:

apps\nest-demo\src\app\bart\summaries\https%3A%2F%2Fwww.abc.net.au%2Fnews%2F2022-01-22%2Faustralian-open-alex-de-minaur-through-to-fourth-round%2F100775774.txt

apps\nest-demo\src\app\bart\summaries\https%3A%2F%2Fwww.foxsports.com.au%2Ftennis%2Faustralian-open-2022-live-scores-results-night-6-updates-and-order-of-play-alex-de-minaur-marin-cilic-vs-andrey-rublev-jannik-sinner%2Fnews-story%2F1c2b6ea3e4216efd61727c19d511dcbe.txt'

OK, yeah, Fox Sports snuck in a result there and I didn't notice.  It works now.

What's next?  Confirm more fields in the generated JSON.

### Alex_de_Minaur

Both links are valid.

https://en.wikipedia.org/wiki/Alex_de_Minaur

https://apnews.com/hub/alex-de-minaur

I select both use checkboxes.  But they are not added:

```json
  "links": {
    "newsLink": "",
    "useAPNewsLink": true,
    "addAPNewsContent": "",
    "wikiLink": "",
    "useWikiLink": "true",
    "addWikiLinkContent": ""
  },
```

The Wikipedia link does get set:

"linkUrl": "https://en.wikipedia.org/wiki/John Madden",

But we should put those is an array in the links section.

At some point we want an array of labels and links from any source, but that's not essential for now.

It's used like this:

```ts
    this.newNewsLink = 'https://apnews.com/hub/' + dashTitle;
    this.newWikiSearchTerm = this.trendTitleSeen;
    this.topicForm.controls.linkUrl.setValue(this.newNewsLink);
    this.topicForm.controls.links['newsLink'].setValue(this.newNewsLink); <-- added
    ...
    onUpdatedNewsSearchTerm() {
     this.newNewsLink = this.topicForm.value.links.newsLink;
    }
```

Actually, it's not emitting, and this value was never implemented.  I think it was expected that these would all be replaced by arrays, which is a much bigger task and has been moved to post-MVP work.

So time to fill the newsLink.  

### AP newsLink

We will need to add a newsLinkLabel as well.

loading Taylor Fritz
trends.component.ts:171 onHandleNewAPSearchTerm undefined
core.js:6456 ERROR TypeError: Cannot read properties of undefined (reading 'setValue')
    at TrendsLinksComponent.ngOnInit (libs_trends_src_index_ts.js:877:51)

Which one is it?

    this.topicForm.controls.linkUrl.setValue(this.newNewsLink);

    this.topicForm.controls.links['newsLink'].setValue(this.newNewsLink);

The second one causes the error.  Not sure why.  Printing out the links object, the value shows it alone is undefined.

value:
addAPNewsContent: ""
addWikiLinkContent: ""
newsLink: undefined

The default value is being overridden.  It must be the emitter is, but why is that not working?

trends-links.component.ts:27 set this.newNewsLink https://apnews.com/hub/Dow-Jones

trends.component.ts:171 new value onHandleNewAPSearchTerm undefined

trends-links sends a new value, but trends receives undefined.

It seems like a normal emitter setup.

I think we are missing an extra form control:

this.topicForm.controls.one['controls']?.commonImg?.setValue(image);

this.topicForm.controls.links['newsLink']?.setValue(this.newNewsLink);

The issue along with making sure to use a controls for each form group, there was no event in our event in the parent class.  So the above should be:

this.topicForm.controls.links['controls']['newsLink'].setValue(this.newNewsLink);

Also, following the smart/dumb component pattern, we want to emit the local child value of the link and let all the setting of form values happen in the parent smart component.

Can anyone notice the error here?

(handleNewAPSearchTerm)="onHandleNewAPSearchTerm()"

It should include the event or the parent will receive an undefined value.

(handleNewAPSearchTerm)="onHandleNewAPSearchTerm($event)"

### Errors in the summary filenames

Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\
https%3A%2F%2Fwww.theguardian.com%2Faustralia-news%2F2022%2Fjan%2F25%2Fgrace-tame-and-scott-morrisons-frosty-meeting-sparks-praise-condemnation-and-memes.txt'

Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\
https%3A%2F%2Fwww.abc.net.au%2Fnews%2F2022-01-25%2Fgrace-tame-criticised-for-cold-interaction-with-prime-minister%2F100781262.txt'

bart.service.getArticleSummary: path ./apps/nest-demo/src/app/bart/summaries/https://www.smh.com.au/national/scowling-at-scott-morrison-grace-tame-squanders-her-moment-20220125-p59r62.html.txt

trends.service.ts:45 kickoffArticleSummary 2 - Error:  HttpErrorResponse {headers: HttpHeaders, status: 201, statusText: 'Created', url: 'http://localhost:3333/api/bart', ok: false, …}
trends.component.ts:335 2-Error: SyntaxError: Une

Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\
https%3A%2F%2Fwww.theguardian.com
%2Faustralia-news%2F2022%2Fjan%2F25%2Fgrace-tame-and-scott-morrisons-frosty-meeting-sparks-praise-condemnation-and-memes.txt'

#### 2-Error: SyntaxError: Unexpected token % in JSON at position 0

To encode or not encode?  It should maybe be done in the Nest bart.controller:

```js
  @Post()
  async getArticleSummary(@Body() article: any) {
    return new Promise((resolve) => {
      this.bartService.getArticleSummary(article.link).then((result: any) => {
        resolve(encodeURIComponent(result));
      });
```

No, then it looks for the summary.txt:

Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summary.txt'

Wait, why isn't the post method getting called?

If there is no article by that name, then the frontend gets this error in what class?

GET http://localhost:3333/api/bart/ 500 (Internal Server Error)

bart.service getArticleSummary service err No model was supplied, defaulted to sshleifer/distilbart-cnn-12-6 (https://huggingface.co/sshleifer/distilbart-cnn-12-6)

bart.controller.findOne: got id https://www.theguardian.com/sport/2022/jan/25/ash-barty-underlines-favourite-status-by-trouncing-pegula-at-australian-open
bart.service.loadSummaryById: https://www.theguardian.com/sport/2022/jan/25/ash-barty-underlines-favourite-status-by-trouncing-pegula-at-australian-open
loadSummary undefined

Just remember to actually try the submit.

At least the AP news link is working.  But the label is not.

```json
"newsLink": "https://apnews.com/hub/Ash-Barty",
"newsLinkLabel": "",
```

That fixed, now it's time to figure out what the regression is on the summary feature.

bart.controller.getArticleSummary: article {
  link: 'https://www.wtatennis.com/news/2462970/keys-sweeps-past-krejcikova-to-reach-australian-open-semifinals'
}

bart.service getArticleSummary service err No model was supplied, defaulted to sshleifer/distilbart-cnn-12-6 
(https://huggingface.co/sshleifer/distilbart-cnn-12-6)

bart.service.getArticleSummary: path ./apps/nest-demo/src/app/bart/summaries/https://www.wtatennis.com/news/2462970/keys-sweeps-past-krejcikova-to-reach-australian-open-semifinals.txt
process err [Error: ENOENT: no such file or directory, open 'C:\Users\timof\repos\timofeysie\satisfactory\apps\nest-demo\src\app\bart\summaries\https:\www.wtatennis.com\news\2462970\keys-sweeps-past-krejcikova-to-reach-australian-open-semifinals.txt'] {
  errno: -4058,
  code: 'ENOENT',
  syscall: 'open',
  path: 'C:\\Users\\timof\\repos\\timofeysie\\satisfactory\\apps\\nest-demo\\src\\app\\bart\\summaries\\https:\\www.wtatennis.com\\news\\2462970\\keys-sweeps-past-krejcikova-to-reach-australian-open-semifinals.txt'    
}

This bart service is where the file should get saved.

async getArticleSummary(articleUrl: any)

The next issue is that the summary is loaded like this:

[{'summary_text': ' "I\'m really just to be able to be the first to be a lot more, not necessarily to be more, and not to have to be to the first of the nation\'s first and the first can\'t 
be a member of the public can\'t say the nation can\'t have a lot of the "I\'ve been just to have the first two and the second two of the first three and the "third two" of the world\'s first two nations, and the fourth and "the first two two and one of the hundred thousand\xa0and the first four\xa0schools\xa0has the first\xa0and first two\xa0and then\xa0the first\xa0person\xa0and third\xa0and fourth\xa0and "the fourth\xa0person" to be\xa0the\xa0and most\xa0the "I can\'t go to the nation" of a nation and the nation has the first "the nation" to begin the nation of the internet, and I\'ve been the first part of the fourth "the world" of "I have to go to be three or two" and not the first six\xa0and that\'s the first way to be in the first school of the next four\xa0and I\'m not really really to be just to say the first one of "that\'s the thing that I\'m just not necessarily" to have a little bit more" to say "to be" to not have to say what the first and that\'s not really" to do the first or to be "the'}]

But shown like this:

of the world\'s first two nations, and the fourth and "the first two two and one of the hundred thousand\xa0and the first four\xa0schools\xa0has the first\xa0and first two\xa0and then\xa0the first\xa0person\xa0and third\xa0and fourth\xa0and "the fourth\xa0person" to be\xa0the\xa0and most\xa0the "I can\'t go to the nation" of a nation and the nation has the first "the nation" to begin the nation of the internet, and I\'ve been the first part of the fourth "the world" of "I have to go to be three or two" and not the first six\xa0and that\'s the first way to be in the first school of the next four\xa0and I\'m not really really to be just to say the first one of "that\'s the thing that I\'m just not necessarily" to have a little bit more" to say "to be" to not have to say what the first and that\'s not really" to do the first or to be "the

This still seems like an issue also, even though it's working most of the time:

2-Error: SyntaxError: Unexpected token % in JSON at position 0
